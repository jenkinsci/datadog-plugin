pipeline {
    agent {
      label 'built-in'
    }
    stages {
        stage('Stage 1') {
            steps {
                sh '''
                echo "Stage 1"
                '''
            }
        }

        stage('Stage 2') {
            options {
                datadog(tags: ["outer_tag:value"])
            }
            stages {
                stage('Stage 2.1') {
                    steps {
                        sh '''
                        echo "Stage 2.1"
                        '''
                    }
                }

                stage('Stage 2.2') {
                    options {
                        datadog(tags: ["inner_tag:another_value"])
                    }
                    steps {
                        sh '''
                        echo "Stage 2.2"
                        '''
                    }
                }

                stage('Stage 2.3') {
                    steps {
                        sh '''
                        echo "Stage 2.3"
                        '''
                    }
                }
            }
        }

        stage('Stage 3') {
            steps {
                sh '''
                echo "Stage 3"
                '''
            }
        }
    }
}
